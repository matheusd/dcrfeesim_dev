# Estimatesmartfee

This repo is a Proof-of-Concept for the `estimatesmartfee` decred command. It's roughly based on Bitcoin core's [v0.14.2](https://github.com/bitcoin/bitcoin/blob/v0.14.2/src/policy/fees.cpp) code.

See the references below for some high level overviews of smart fee estimation in bitcoin.

This code runs a simulator (**not** decred's simnet) to check whether the algorithm is roughly correct.

## Simulator

The current simulator code is very simple: at every new block it generates a bunch of transactions following a distribution based on `rand.ExpFloat64()`, scaled to values eyeballed to look somewhat reasonable.

This probably needs serious improvements.

The miner is also very simple: it sorts txs by fee rate and includes txs until the block is filled. It doesn't use priority rules nor tries to fill the remaining space by using remaining transactions.

## Estimator

The basic idea of the estimator is to track how many transactions are mined at each fee rate bucket/confirmation rate bucket.

A fee rate bucket groups transactions that have fees within a given range (eg: transactions that are paying 0.0010-0.0015 DCR/KB as transaction fees).

A confirmation rate bucket tracks transactions confirmed within a given window after being seen on the mempool (eg: transactions included within 8-10 blocks after being published to the network). Right now this is tracked individually.

After seeing a number of transactions, the estimator can then estimate the median fee paid by transactions confirmed within X blocks after being published to the network by looking at the buckets at the desired confirmation level. It tries to minimize the fees by looking backwards (that is, starting at the highest fee bucket) until less than 95% of the transactions have been mined at the given confirmation/bucket level.

## Results

This is the important bit. What should I use as fee rate (in DCR/KB) if I want to have the tx confirmed in at most N blocks?

```
=== Fees to use for minConf confirmations ===
           1           2           4           6           8         100
  0.00204761  0.00137703  0.00092383  0.00061848  0.00000064  0.00000064
```

These are histograms of the raw simulated data. The point of these is to see if the code generating transactions and blocks is reasonable (ie, looks like what we'd see in real life).

```
=== Histograms for simulated data ===
Block Size Histogram
    0.26    0.43    0.74    1.26    2.13    3.63    6.17   10.49   17.83   30.30   51.52   87.58  148.89  253.11  390.93
      44       9      18      34      42     103     121     206     409     677    1109    1780    2718   18649       0

Tx Size Histogram
    0.26    0.43    0.74    1.26    2.13    3.63    6.17   10.49   17.83   30.30   51.52   87.58  148.89  253.11  390.93
 1270488 1371875 1557201 1345814  741996  197989   16555     382     226     194       0       0       0       0       0

Fee Rate Histogram
   0.00001   0.00003   0.00009   0.00027   0.00081   0.00243   0.00729   0.02187   0.06561   0.19683   0.59049   1.77147
         0    192024    367318    978724   2072621   2320658    567078      4297         0         0         0         0

Tx per block Histogram
     1     2     4     8    16    32    64   128   256   512  1024  2048  4096
    73    89   163   285   627  1205  2269  3978 17230     0     0     0     0
```

This is the internal estimator bucket data (ie, the average fee for each fee bucket at each confirmation range + the number of transactions tracked on that cell).

```
=== Internal Estimator State ===
          |                0|                1|                2|                3|                4|                5|                6|                7|
0.00000010| 0.00000000     0| 0.00000006     4| 0.00000007     6| 0.00000007     7| 0.00000008     9| 0.00000008     9| 0.00000007    11| 0.00000007    20
0.00000015| 0.00000000     0| 0.00000018     5| 0.00000018     6| 0.00000019     8| 0.00000019     8| 0.00000018    10| 0.00000019    10| 0.00000019    14
0.00000022| 0.00000000     0| 0.00000029     4| 0.00000029     4| 0.00000029     6| 0.00000028     6| 0.00000028     7| 0.00000029     8| 0.00000028    13
0.00000034| 0.00000000     0| 0.00000043     5| 0.00000043     8| 0.00000043    10| 0.00000044    12| 0.00000044    14| 0.00000044    16| 0.00000043    25
0.00000051| 0.00000000     0| 0.00000066     6| 0.00000065     8| 0.00000063    11| 0.00000064    14| 0.00000063    16| 0.00000063    17| 0.00000064    29
0.00000076| 0.00000000     0| 0.00000092    10| 0.00000091    13| 0.00000091    16| 0.00000093    19| 0.00000093    21| 0.00000093    23| 0.00000094    47
0.00000114| 0.00000000     0| 0.00000149    16| 0.00000147    23| 0.00000145    29| 0.00000145    31| 0.00000144    34| 0.00000144    35| 0.00000144    65
0.00000171| 0.00000000     0| 0.00000214    31| 0.00000214    46| 0.00000213    54| 0.00000212    64| 0.00000212    73| 0.00000213    78| 0.00000213   116
0.00000256| 0.00000000     0| 0.00000326    31| 0.00000327    51| 0.00000325    66| 0.00000326    78| 0.00000324    85| 0.00000324    92| 0.00000321   161
0.00000384| 0.00000000     0| 0.00000484    54| 0.00000483    78| 0.00000484    97| 0.00000486   117| 0.00000485   133| 0.00000485   142| 0.00000481   243
0.00000577| 0.00000000     0| 0.00000724    75| 0.00000719   115| 0.00000721   148| 0.00000724   174| 0.00000724   195| 0.00000723   213| 0.00000720   360
0.00000865| 0.00000000     0| 0.00001097   116| 0.00001091   172| 0.00001083   219| 0.00001082   263| 0.00001080   294| 0.00001079   314| 0.00001081   546
0.00001297| 0.00000000     0| 0.00001615   161| 0.00001612   244| 0.00001617   313| 0.00001617   364| 0.00001616   410| 0.00001616   447| 0.00001617   774
0.00001946| 0.00000000     0| 0.00002425   250| 0.00002430   402| 0.00002429   507| 0.00002431   594| 0.00002430   660| 0.00002430   710| 0.00002435  1154
0.00002919| 0.00000000     0| 0.00003654   398| 0.00003645   603| 0.00003647   772| 0.00003651   900| 0.00003648  1005| 0.00003649  1093| 0.00003646  1730
0.00004379| 0.00000000     0| 0.00005490   635| 0.00005482   927| 0.00005483  1162| 0.00005479  1381| 0.00005478  1515| 0.00005477  1642| 0.00005474  2514
0.00006568| 0.00000000     0| 0.00008236  1020| 0.00008241  1532| 0.00008235  1876| 0.00008225  2203| 0.00008221  2404| 0.00008225  2602| 0.00008202  3754
0.00009853| 0.00000000     0| 0.00012348  1637| 0.00012343  2418| 0.00012350  3000| 0.00012342  3454| 0.00012344  3785| 0.00012340  4048| 0.00012310  5488
0.00014779| 0.00000000     0| 0.00018567  2745| 0.00018528  3869| 0.00018509  4796| 0.00018491  5487| 0.00018486  5956| 0.00018487  6285| 0.00018432  7745
0.00022168| 0.00000000     0| 0.00027768  4369| 0.00027780  6009| 0.00027736  7408| 0.00027718  8364| 0.00027718  8922| 0.00027711  9308| 0.00027640 10591
0.00033253| 0.00000000     0| 0.00041604  6929| 0.00041573  9488| 0.00041519 11139| 0.00041414 11966| 0.00041390 12474| 0.00041384 12865| 0.00041266 13805
0.00049879| 0.00000000     0| 0.00062324 10392| 0.00062189 13743| 0.00062034 15295| 0.00062013 15935| 0.00061972 16292| 0.00061888 16534| 0.00061848 16850
0.00074818| 0.00000000     0| 0.00093078 14523| 0.00092582 17623| 0.00092517 18230| 0.00092409 18505| 0.00092422 18616| 0.00092417 18667| 0.00092383 18728
0.00112227| 0.00000000     0| 0.00138385 16371| 0.00137805 17365| 0.00137752 17425| 0.00137724 17457| 0.00137703 17473| 0.00137703 17473| 0.00137703 17473
0.00168341| 0.00000000     0| 0.00204854 13189| 0.00204761 13234| 0.00204761 13234| 0.00204761 13234| 0.00204761 13234| 0.00204761 13234| 0.00204761 13234
0.00252512| 0.00000000     0| 0.00302646  7244| 0.00302646  7244| 0.00302646  7244| 0.00302646  7244| 0.00302646  7244| 0.00302646  7244| 0.00302646  7244
0.00378768| 0.00000000     0| 0.00444606  2371| 0.00444606  2371| 0.00444606  2371| 0.00444606  2371| 0.00444606  2371| 0.00444606  2371| 0.00444606  2371
0.00568151| 0.00000000     0| 0.00653422   397| 0.00653422   397| 0.00653422   397| 0.00653422   397| 0.00653422   397| 0.00653422   397| 0.00653422   397
0.00852227| 0.00000000     0| 0.00969359    23| 0.00969359    23| 0.00969359    23| 0.00969359    23| 0.00969359    23| 0.00969359    23| 0.00969359    23
0.01278340| 0.00000000     0| 0.01480401     0| 0.01480401     0| 0.01480401     0| 0.01480401     0| 0.01480401     0| 0.01480401     0| 0.01480401     0
0.01917511| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0
0.02876266| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0
0.04314399| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0
0.06471598| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0
0.09707397| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0
0.14561096| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0
0.21841644| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0
0.32762466| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0
0.49143699| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0
0.73715549| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0
1.10573323| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0
1.65859985| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0| 0.00000000     0
```

## References

https://bitcointechtalk.com/an-introduction-to-bitcoin-core-fee-estimation-27920880ad0

https://gist.github.com/morcos/d3637f015bc4e607e1fd10d8351e9f41
